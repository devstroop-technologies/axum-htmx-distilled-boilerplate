name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  IMAGE_NAME: axum-htmx-app

jobs:
  # ── Cargo build + check ──────────────────────────────────────────────────
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test --release

  # ── Docker image build + startup test ────────────────────────────────────
  docker:
    name: Docker Build & Startup Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start container
        run: |
          docker run -d \
            --name test-app \
            -p 8000:8000 \
            -e APP__SERVER__HOST=0.0.0.0 \
            -e APP__SERVER__PORT=8000 \
            -e "APP__DATABASE__URL=sqlite:///app/data/app.db?mode=rwc" \
            ${{ env.IMAGE_NAME }}:test

      - name: Container status
        run: docker ps -a --filter name=test-app

      - name: Wait for healthy startup
        run: |
          echo "Waiting for app to start..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/healthz > /dev/null 2>&1; then
              echo "App is up after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "App failed to start within 30s"
          docker logs test-app 2>&1
          exit 1

      - name: Verify health endpoint
        run: |
          curl -sf http://localhost:8000/healthz
          echo " → /healthz OK"

      - name: Verify pages return 200
        run: |
          set -e
          for path in "/" "/about" "/demo"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000${path}")
            echo "GET ${path} → ${status}"
            if [ "$status" != "200" ]; then
              echo "FAIL: expected 200, got ${status}"
              exit 1
            fi
          done

      - name: Verify partials return 200
        run: |
          set -e
          for path in "/partials/status-card" "/partials/item-list"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000${path}")
            echo "GET ${path} → ${status}"
            if [ "$status" != "200" ]; then
              echo "FAIL: expected 200, got ${status}"
              exit 1
            fi
          done

      - name: Verify static assets served
        run: |
          set -e
          for path in "/static/js/htmx.min.js" "/static/css/app.css"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000${path}")
            echo "GET ${path} → ${status}"
            if [ "$status" != "200" ]; then
              echo "FAIL: expected 200, got ${status}"
              exit 1
            fi
          done

      - name: Print container logs
        if: always()
        run: docker logs test-app

      - name: Cleanup
        if: always()
        run: docker rm -f test-app
